# PRD：字幕顯示系統改進

## 概述

本次改進針對 Auto-Sub 的字幕顯示系統，解決目前使用上的痛點，提升用戶體驗。

### 問題陳述

| 問題 | 現況 | 影響 |
|------|------|------|
| 文字截斷 | 長文字顯示「...」 | 無法看完整字幕 |
| 框不貼合 | 固定 120pt 高度 | 浪費空間或內容溢出 |
| 無歷史記錄 | 只顯示當前字幕 | 錯過就看不到了 |
| 翻譯等待 | 等翻譯完才顯示 | 感覺延遲較長 |
| 無法移動 | 固定在底部中央 | 可能遮擋重要內容 |
| 無鎖定功能 | N/A | 容易誤觸移動 |

---

## 目標

1. **字幕完整顯示**：不截斷、支援換行、動態調整大小
2. **歷史記錄**：保留最近幾筆字幕，視覺上有層次感
3. **即時回饋**：先顯示原文，翻譯完成後補上
4. **位置自訂**：可拖動、可鎖定、位置持久化

---

## 功能規格

### 1. 字幕框尺寸規則

#### 最大尺寸限制

| 屬性 | 設定 | 說明 |
|------|------|------|
| 最大寬度 | 螢幕寬度 80% | 超出自動換行（word wrap） |
| 最大高度 | 螢幕高度 20% | 超出顯示捲軸 |
| 最小尺寸 | 內容自適應 | 內容少時框縮小貼合 |

#### 捲軸行為

- 內容超出最大高度時，顯示垂直捲軸
- 新字幕進來時，自動捲動到底部（顯示最新內容）
- 用戶手動捲動時，暫停自動捲動
- 用戶捲到底部時，恢復自動捲動

#### 文字換行

- 單行文字超出最大寬度時自動換行
- 換行以單詞/字元為單位（中日文以字元、英文以單詞）
- 禁止截斷（不顯示「...」）

### 2. 歷史字幕顯示

#### 保留數量

- 顯示最近 **3 筆**字幕（包含當前）
- 超過 3 筆時，最舊的自動移除

#### 視覺層次

| 位置 | 透明度 | 說明 |
|------|--------|------|
| 最新（底部） | 100% | 當前字幕，最醒目 |
| 次新 | 60% | 稍微淡化 |
| 最舊（頂部） | 30% | 明顯淡化 |

#### 字幕結構（每筆）

```
┌─────────────────────────────────────────┐
│ 日本語の原文がここに表示されます         │  ← 原文（字體較小 85%）
│ 翻譯的中文顯示在這裡                     │  ← 翻譯（正常字體）
└─────────────────────────────────────────┘
```

### 3. 即時原文 + 延遲翻譯

#### 顯示流程

```
時間軸：
t=0     收到原文 → 立即顯示原文
t=0.5s  收到翻譯 → 補上翻譯文字

視覺效果：
┌───────────────────────┐      ┌───────────────────────┐
│ 今日は天気がいいですね │  →   │ 今日は天気がいいですね │
│ （翻譯中...）          │      │ 今天天氣真好呢         │
└───────────────────────┘      └───────────────────────┘
```

#### IPC 協議變更

**新增訊息類型**：`transcript`

```json
// 原文即時送出（語音辨識完成時）
{"type": "transcript", "text": "今日は天気がいいですね", "id": "uuid-123"}

// 翻譯完成後送出
{"type": "subtitle", "id": "uuid-123", "original": "今日は天気がいいですね", "translation": "今天天氣真好呢"}
```

**欄位說明**：

| 欄位 | 類型 | 說明 |
|------|------|------|
| type | string | `transcript` 或 `subtitle` |
| id | string | UUID，用於配對原文和翻譯 |
| text | string | 原文（僅 transcript 類型） |
| original | string | 原文（僅 subtitle 類型） |
| translation | string | 翻譯（僅 subtitle 類型） |

#### UI 狀態管理

```swift
struct SubtitleEntry {
    let id: UUID
    var originalText: String
    var translatedText: String?  // nil 表示翻譯中
    let timestamp: Date

    var isTranslating: Bool {
        translatedText == nil
    }
}
```

### 4. 字幕框移動功能

#### 拖曳把手

- **位置**：字幕框右上角
- **圖示**：拖曳把手圖示（⠿ 或類似）
- **大小**：約 24x24pt，可點擊區域適當放大

#### 互動行為

| 狀態 | 把手 | 字幕框 | 滑鼠事件 |
|------|------|--------|---------|
| 鎖定 | 隱藏 | 點擊穿透 | 全部穿透 |
| 解鎖 | 顯示 | 可拖動 | 把手區域可互動 |

#### 拖動規則

- 只能在螢幕可見範圍內移動
- 不能拖出螢幕邊界
- 拖動時顯示半透明預覽

### 5. 鎖定/解鎖功能

#### 切換方式

- **主要**：點擊字幕框右上角的把手圖示
- **次要**：Menu Bar 選單中的「鎖定字幕位置」選項

#### 狀態指示

| 狀態 | 把手圖示 | Menu Bar |
|------|---------|----------|
| 鎖定 | 隱藏（或鎖頭圖示） | ✓ 鎖定字幕位置 |
| 解鎖 | 拖曳把手圖示 | ☐ 鎖定字幕位置 |

#### 預設狀態

- App 啟動時預設為**鎖定**狀態
- 用戶需主動解鎖才能移動

### 6. 位置持久化

#### 儲存內容

```swift
struct SubtitlePosition: Codable {
    var x: CGFloat      // 字幕框左上角 x 座標
    var y: CGFloat      // 字幕框左上角 y 座標
    var isLocked: Bool  // 鎖定狀態
}
```

#### 儲存位置

- 使用 `UserDefaults`
- Key: `subtitlePosition`

#### 行為

- 每次位置變更後自動儲存
- App 啟動時讀取並恢復位置
- 若無儲存位置，使用預設位置（螢幕底部中央）

---

## UI/UX 設計

### 字幕框視覺設計

```
解鎖狀態：
┌─────────────────────────────────────────────────┬───┐
│                                                 │ ⠿ │ ← 拖曳把手
├─────────────────────────────────────────────────┴───┤
│ 前の字幕がここに表示されます                          │ ← 歷史（30% 透明度）
│ 之前的字幕顯示在這裡                                  │
├─────────────────────────────────────────────────────┤
│ 一つ前の字幕                                         │ ← 歷史（60% 透明度）
│ 上一句字幕                                           │
├─────────────────────────────────────────────────────┤
│ 今日は天気がいいですね                                │ ← 當前（100%）
│ 今天天氣真好呢                                        │
└─────────────────────────────────────────────────────┘

鎖定狀態：
┌─────────────────────────────────────────────────────┐
│ 前の字幕がここに表示されます                          │
│ 之前的字幕顯示在這裡                                  │
├─────────────────────────────────────────────────────┤
│ ...（同上，但無把手）                                 │
└─────────────────────────────────────────────────────┘
```

### 翻譯中狀態

```
┌─────────────────────────────────────────────────────┐
│ 今日は天気がいいですね                                │
│ 翻譯中...                                            │ ← 灰色斜體
└─────────────────────────────────────────────────────┘
```

### Menu Bar 選單更新

```
┌─────────────────────────┐
│ ● 開始擷取              │
├─────────────────────────┤
│   來源語言：日語        │
│   目標語言：繁體中文    │
├─────────────────────────┤
│ ☐ 鎖定字幕位置          │  ← 新增
│   重設字幕位置          │  ← 新增
├─────────────────────────┤
│   設定...               │
│   關於                  │
│   結束                  │
└─────────────────────────┘
```

---

## 技術實作要點

### Swift 端變更

| 檔案 | 變更 |
|------|------|
| `SubtitleEntry.swift` | 新增 `id` 欄位、`translatedText` 改為 Optional |
| `AppState.swift` | 新增 `subtitleHistory: [SubtitleEntry]`、`isSubtitleLocked: Bool` |
| `SubtitleOverlay.swift` | 重寫：歷史顯示、動態尺寸、捲軸、拖曳把手 |
| `SubtitleWindowController.swift` | 支援動態尺寸、位置持久化、鎖定邏輯 |
| `PythonBridgeService.swift` | 解析新的 `transcript` 訊息類型 |
| `MenuBarView.swift` | 新增鎖定/重設選項 |

### Python 端變更

| 檔案 | 變更 |
|------|------|
| `main.py` | 新增 `transcript` 訊息輸出 |
| `transcriber.py` | 分段完成時先送 `transcript`，再送給翻譯 |
| `translator.py` | 翻譯完成後送 `subtitle`（含 id 配對） |

### 資料流變更

```
目前：
Transcriber → Translator → {"type":"subtitle", ...}

改進後：
Transcriber → {"type":"transcript", "id":"...", "text":"..."} → stdout
           ↘ Translator → {"type":"subtitle", "id":"...", ...} → stdout
```

---

## 驗收標準

### 功能驗收

- [ ] 長文字自動換行，不顯示截斷符號
- [ ] 字幕框高度隨內容動態調整
- [ ] 超出最大高度時出現捲軸
- [ ] 新字幕自動捲到底部
- [ ] 顯示最近 3 筆字幕，透明度遞減
- [ ] 原文先顯示，翻譯後補上
- [ ] 翻譯中顯示「翻譯中...」提示
- [ ] 解鎖時可拖動字幕框
- [ ] 鎖定時點擊穿透
- [ ] 位置跨 session 保存
- [ ] Menu Bar 可切換鎖定狀態
- [ ] 可重設字幕位置到預設

### 效能驗收

- [ ] 字幕更新無明顯延遲
- [ ] 拖動時無卡頓
- [ ] 記憶體使用無明顯增加

---

## 開發計劃

### Phase 1：字幕框基礎改進

| 任務 | 說明 |
|------|------|
| 動態尺寸 | 移除固定高度，改為內容自適應 |
| 最大尺寸 | 加入最大寬高限制 |
| 文字換行 | 確保不截斷 |
| 捲軸 | 超出最大高度時顯示 |

### Phase 2：歷史記錄

| 任務 | 說明 |
|------|------|
| 資料結構 | AppState 新增 subtitleHistory |
| UI 顯示 | 多筆字幕堆疊顯示 |
| 透明度 | 依新舊程度調整 |

### Phase 3：即時原文

| 任務 | 說明 |
|------|------|
| IPC 協議 | 新增 transcript 訊息類型 |
| Python 端 | 分兩階段送出 |
| Swift 端 | 處理配對邏輯 |
| UI | 翻譯中狀態顯示 |

### Phase 4：移動與鎖定

| 任務 | 說明 |
|------|------|
| 拖曳把手 | UI 實作 |
| 拖動邏輯 | 視窗移動 |
| 鎖定狀態 | 點擊穿透切換 |
| 位置持久化 | UserDefaults 儲存 |
| Menu Bar | 新增選項 |

---

## 相關文件

- [001-initial-implementation/PRD.md](../001-initial-implementation/PRD.md) - 初始實作 PRD
- [001-initial-implementation/SPEC.md](../001-initial-implementation/SPEC.md) - 初始實作技術規格
