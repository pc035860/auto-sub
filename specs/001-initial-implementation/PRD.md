# PRD：Auto-Sub 即時字幕翻譯

## 產品概述

Auto-Sub 是一款 macOS 應用程式，能即時擷取系統播放的音訊，進行語音辨識並翻譯，最後以字幕覆蓋層的形式顯示在螢幕上。

### 使用情境

- 觀看日語動畫、影片時即時顯示繁體中文字幕
- 收聽日語 Podcast、直播時即時翻譯
- 任何播放日語音訊的應用程式都能使用

### PoC 驗證結果

| 指標 | 結果 | 評價 |
|------|------|------|
| 總延遲 | 0.5-1.0 秒 | ✅ 優於目標 3 秒 |
| 翻譯品質 | 可理解 | ✅ 可接受 |
| 系統資源 | 低 | ✅ 不影響其他應用 |

---

## 目標用戶

**主要用戶**：個人使用者

- 經常觀看日語內容（動畫、影片、直播）
- 日語聽力不足以完全理解，需要字幕輔助
- 願意付出少量月費（~$5）換取便利性

**使用頻率**：每月約 10 小時

---

## 核心功能

### MVP（Phase 1）

| 功能 | 說明 | 優先級 |
|------|------|--------|
| 系統音訊擷取 | 擷取 macOS 所有音訊輸出 | P0 |
| 即時語音辨識 | 日語 → 文字（Deepgram） | P0 |
| 即時翻譯 | 日文 → 繁體中文（Gemini），失敗時重試 2-3 次 | P0 |
| 字幕覆蓋層 | 半透明視窗顯示雙語字幕（原文+翻譯） | P0 |
| 開始/停止控制 | Menu Bar 圖示或快捷鍵 | P0 |
| App 內設定 | API Key 設定、首次使用引導（不需終端機） | P0 |
| 錯誤狀態回饋 | Menu Bar 圖示變色表示異常 | P0 |

### Phase 2（優化）

| 功能 | 說明 | 優先級 |
|------|------|--------|
| 字幕樣式設定 | 字體、大小、顏色、位置 | P1 |
| 專有名詞對照表 | 自定義翻譯對照 | P1 |
| 句子合併優化 | 調整 endpoint 時間（300ms → 500ms+） | P1 |
| 雙語顯示切換 | 可選擇只顯示翻譯或雙語 | P1 |
| 音訊來源選擇 | 選擇特定應用程式的音訊 | P2 |
| 多語言支援 | 英語、韓語來源 | P2 |

### Phase 3（進階）

| 功能 | 說明 | 優先級 |
|------|------|--------|
| 歷史記錄 | 儲存字幕記錄 | P2 |
| 說話者分離 | 多人對話時標示不同說話者 | P2 |
| 本地模型選項 | Whisper 離線模式 | P3 |

---

## 非功能需求

### 效能

| 指標 | 目標 |
|------|------|
| 總延遲 | < 2 秒 |
| CPU 使用率 | < 10%（閒置時 < 1%） |
| 記憶體使用 | < 100MB |

### 可靠性

- 網路中斷時優雅降級（顯示提示，不崩潰）
- 長時間運行穩定（> 4 小時不需重啟）

### 相容性

- macOS 13.0+（需要 ScreenCaptureKit）
- Apple Silicon（M1/M2/M3）優先，Intel 相容

---

## 技術架構

### 架構決定

經過評估，採用 **Swift + Python 混合架構（不打包 Python）**：

| 決定 | 選擇 | 原因 |
|------|------|------|
| 架構 | Swift + Python 混合 | 複用 PoC、降低風險 |
| UI 框架 | SwiftUI | 聲明式、前端友善 |
| 打包方式 | 獨立發布（不上 App Store） | 免費、自由、個人使用 |
| Python 打包 | **不打包**，依賴用戶環境 | App 體積小、開發迭代快 |

### 系統架構圖

```
┌─────────────────────────────────────────────────────────┐
│              Swift App (AutoSub.app)                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │           ScreenCaptureKit 音訊擷取               │  │
│  │        （原 systemAudioDump 功能整合至此）         │  │
│  └───────────────────┬───────────────────────────────┘  │
│                      │ 音訊資料 (stdin)                 │
│                      ▼                                  │
│  ┌───────────────────────────────────────────────────┐  │
│  │              Python 子程序                         │  │
│  │   ┌─────────────┐      ┌─────────────┐           │  │
│  │   │  Deepgram   │ ───► │   Gemini    │           │  │
│  │   │    STT      │      │   翻譯      │           │  │
│  │   └─────────────┘      └─────────────┘           │  │
│  └───────────────────┬───────────────────────────────┘  │
│                      │ 字幕文字 (stdout)                │
│                      ▼                                  │
│  ┌───────────────────────────────────────────────────┐  │
│  │         SwiftUI 字幕覆蓋層 (NSWindow)              │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  Menu Bar Icon  │  Settings  │  Keyboard Shortcuts      │
└─────────────────────────────────────────────────────────┘
```

### 分工

| 部分 | 語言 | 負責 |
|------|------|------|
| 音訊擷取 | **Swift** | ScreenCaptureKit（整合在 App 內） |
| UI / 字幕顯示 | **Swift** | SwiftUI + NSWindow |
| 語音辨識 | **Python** | Deepgram WebSocket |
| 翻譯 | **Python** | Gemini API |

### 進程間通訊

Swift 與 Python 透過 **stdin/stdout** 通訊：

```
Swift App                          Python Backend
    │                                   │
    │──── 音訊 PCM 資料 (stdin) ────►   │
    │                                   │
    │◄─── 字幕 JSON (stdout) ──────     │
    │     {"text": "...", "translation": "..."}
```

### 技術選型

| 組件 | 技術 | 原因 |
|------|------|------|
| 語言 | Swift + Python | Swift 做 UI + 音訊，Python 做 AI |
| 音訊擷取 | ScreenCaptureKit | Apple 官方 API，整合在 App 內 |
| 語音辨識 | Deepgram Nova-2 | 低延遲串流、支援日語 |
| 翻譯 | Gemini 2.5 Flash Lite | 低成本、可自訂 prompt |
| UI 框架 | SwiftUI | 現代、簡潔 |
| 字幕覆蓋 | NSWindow | 跨應用顯示 |

### App Bundle 結構

```
AutoSub.app/
└── Contents/
    ├── MacOS/
    │   └── AutoSub              # Swift 主程式（~5MB）
    ├── Resources/
    │   └── backend/
    │       ├── main.py          # Python 入口
    │       ├── transcriber.py   # Deepgram 串接
    │       ├── translator.py    # Gemini 翻譯
    │       └── requirements.txt
    └── Info.plist
```

**App 體積**：~5MB（不含 Python 環境）

**運行時資料**（由 App 自動建立）：
```
~/Library/Application Support/AutoSub/
├── .venv/               # Python 虛擬環境
├── config.json          # API Keys 和設定
└── logs/                # 執行日誌
```

---

## 用戶前置作業

由於採用不打包 Python 的方案，用戶需要先安裝 Python 環境。

### 系統需求

- macOS 13.0+
- Python 3.11+（`brew install python3`）
- 螢幕錄製權限

### 首次使用流程

1. **安裝 Python**（如尚未安裝）
   ```bash
   brew install python3
   ```

2. **開啟 App**
   - App 會自動檢測 Python 環境
   - 若環境未就緒，會顯示引導畫面

3. **App 內設定**（約 1 分鐘）
   - App 自動建立虛擬環境並安裝依賴
   - 在設定畫面輸入 API Keys
   - 授權螢幕錄製權限

### 日常使用

設定完成後，直接開啟 App 即可使用，不需執行任何終端機指令。

---

## API 成本估算

**假設：每月使用 10 小時（600 分鐘）**

| 服務 | 單價 | 月成本 | 免費額度 |
|------|------|--------|---------|
| Deepgram Nova-2 | $0.0077/分鐘 | $4.62 | $200 credit |
| Gemini Flash Lite | ~$0.001/請求 | ~$1-2 | 有免費額度 |
| **總計** | | **~$5-7/月** | 初期免費 |

---

## UI/UX 設計

### Menu Bar

```
┌─────┐
│ 字 │  ← Menu Bar 圖示（正常：白色，錯誤：紅色，警告：黃色）
└──┬──┘
   │
   ▼
┌─────────────────────┐
│ ● 開始擷取          │  ← 點擊切換開始/停止
├─────────────────────┤
│   來源語言：日語    │
│   目標語言：繁體中文 │
├─────────────────────┤
│   設定...           │  ← 開啟設定視窗
│   關於              │
│   結束              │
└─────────────────────┘

圖示狀態：
- ⚪ 白色：正常待機
- 🟢 綠色：正在擷取中
- 🟡 黃色：警告（如網路不穩）
- 🔴 紅色：錯誤（如 API 失敗）
```

### 設定視窗

```
┌─────────────────────────────────────┐
│            Auto-Sub 設定            │
├─────────────────────────────────────┤
│  🔑 API Keys                        │
│  ┌───────────────────────────────┐  │
│  │ Deepgram API Key              │  │
│  │ [________________________]    │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ Gemini API Key                │  │
│  │ [________________________]    │  │
│  └───────────────────────────────┘  │
│                                     │
│  🌐 語言設定                        │
│  來源語言：[日語 ▼]                 │
│  目標語言：[繁體中文 ▼]             │
│                                     │
│           [儲存]  [取消]            │
└─────────────────────────────────────┘
```

### 字幕覆蓋層

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│                     （影片內容）                          │
│                                                          │
│                                                          │
│                                                          │
├──────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────┐   │
│  │ 私は気楽に物事を受け入れる友達が大好きです          │   │
│  │ 我好喜歡那些輕鬆接受事物的朋友                      │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘

字幕特性：
- 位置：螢幕底部（可調整）
- 背景：半透明黑色
- 字體：系統字體，可調大小
- 點擊穿透：不影響下方視窗操作
- 雙語顯示：上方原文、下方翻譯

字幕行為：
- 無聲音時：隱藏整個字幕區域
- 顯示時間：固定時間後自動消失（約 3-5 秒）
- 新字幕：立即取代舊字幕
```

### 快捷鍵

| 動作 | 預設快捷鍵 |
|------|-----------|
| 開始/停止 | `⌘ + Shift + S` |
| 隱藏字幕 | `⌘ + Shift + H` |

---

## MVP 開發計劃

### 階段 1：核心功能（預估 1-2 週）

| 任務 | 說明 |
|------|------|
| 專案架構 | 建立 Swift + Python 混合專案 |
| 音訊擷取 | 整合 ScreenCaptureKit |
| 後端服務 | Python 服務串接 Deepgram + Gemini |
| 字幕顯示 | NSWindow 覆蓋層 |
| Menu Bar | 基本控制介面 |

### 階段 2：優化（預估 1 週）

| 任務 | 說明 |
|------|------|
| 句子合併 | 減少碎片化輸出 |
| 錯誤處理 | 網路中斷、API 錯誤 |
| 設定介面 | 字幕樣式設定 |

### 階段 3：打磨（預估 1 週）

| 任務 | 說明 |
|------|------|
| 開機自動啟動 | Launch at Login |
| 效能優化 | 減少資源消耗 |
| 測試 | 長時間運行測試 |

---

## 已知問題與解決方案

### 從 PoC 發現的問題

| 問題 | 原因 | 解決方案 |
|------|------|---------|
| 句子被切斷 | endpointing 300ms 太短 | Phase 2：調整為 500ms+ |
| 專有名詞不一致 | prompt 未指定對照表 | Phase 2：加入可自訂的對照表功能 |
| 偶爾漏翻 | Gemini 偶爾失誤 | MVP：重試 2-3 次 |
| 背景音效干擾 | 音樂/音效混入語音 | 不處理，交給 Deepgram 判斷 |
| 多人對話混亂 | 無法區分說話者 | Phase 3：說話者分離功能 |

### 技術風險

| 風險 | 影響 | 緩解措施 |
|------|------|---------|
| API 價格調漲 | 成本增加 | 預留本地模型 fallback |
| Deepgram 服務中斷 | 無法使用 | 加入離線提示 |
| macOS 權限變更 | 需要重新授權 | 清楚的權限引導 |

---

## 成功指標

### 功能指標

- [ ] 能正常擷取系統音訊
- [ ] 語音辨識準確率 > 85%
- [ ] 翻譯延遲 < 2 秒
- [ ] 連續運行 4 小時無崩潰

### 用戶體驗指標

- [ ] 首次設定 < 3 分鐘（App 內完成）
- [ ] 日常使用一鍵開始
- [ ] 字幕可讀性良好（雙語顯示清晰）
- [ ] 錯誤狀態清楚可見（Menu Bar 圖示）

---

## 附錄

### A. PoC 程式碼位置

```
poc/
├── poc.py           # 主程式
├── audio_capture.py # 音訊擷取（PoC 用，正式版由 Swift 處理）
├── transcriber.py   # Deepgram 串接（複用）
├── translator.py    # Gemini 翻譯（複用）
└── systemAudioDump/ # Swift 音訊擷取工具（PoC 用，正式版整合至 App）
```

### B. 正式版 Python Backend 結構

```
backend/
├── main.py          # 入口，從 stdin 讀取音訊
├── transcriber.py   # Deepgram 串接（從 PoC 複用）
├── translator.py    # Gemini 翻譯（從 PoC 複用）
├── requirements.txt
├── setup.sh
└── .env.example
```

### C. 參考資源

- [ScreenCaptureKit 文件](https://developer.apple.com/documentation/screencapturekit)
- [Deepgram SDK v5](https://developers.deepgram.com/docs/python-sdk)
- [Gemini API](https://ai.google.dev/gemini-api/docs)
- [SwiftUI 教學](https://developer.apple.com/tutorials/swiftui)
